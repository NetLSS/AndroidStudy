<!-- 
commit message
kotlin in action : Annotation

μƒλµ λ μ±•ν„°λ” ν–¥ν›„ μ±„μ›μ§ μμ •. π…
-->

# 10μ¥ μ—λ…Έν…μ΄μ…κ³Ό λ¦¬ν”λ ‰μ…

- Annotation κ³Ό Reflection μ„ μ‚¬μ©ν•λ©΄ λ―Έλ¦¬ μ•μ§€ λ»ν•λ” μ„μμ ν΄λμ¤λ¥Ό λ‹¤λ£° μ μλ‹¤.
    - μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν•λ©΄ λΌμ΄λΈλ¬λ¦¬κ°€ μ”κµ¬ν•λ” μλ―Έλ¥Ό ν΄λμ¤μ—κ² λ¶€μ—¬ν•  μ μλ‹¤.
    - λ¦¬ν”λ ‰μ…μ„ μ‚¬μ©ν•λ©΄ μ‹¤ν–‰ μ‹μ μ— μ»΄νμΌλ¬ λ‚΄λ¶€ κµ¬μ΅°λ¥Ό λ¶„μ„ν•  μ μλ‹¤.

## 10.1 μ• λ…Έν…μ΄μ… μ„ μ–Έκ³Ό μ μ©

### 10.1.1 μ• λ…Έν…μ΄μ… μ μ©

μλ°”μ™€ κ°™μ€ λ°©λ²•μΌλ΅ μ μ©ν•λ ¤λ” λ€μƒ μ•μ— μ• λ…Έν…μ΄μ…μ„ λ¶™μ΄λ©΄λλ‹¤.

μ• λ…Έν…μ΄μ…μ€ @κ³Ό μ• λ…Έν…μ΄μ… μ΄λ¦„μΌλ΅ κµ¬μ„±λλ‹¤.

ν•¨μλ‚ ν΄λμ¤ λ“± μ—¬λ¬ λ‹¤λ¥Έ μ½”λ“ κµ¬μ„± μ”μ†μ— μ• λ…Έν…μ΄μ…μ„ λ¶™μΌ μ μλ‹¤.

**μμ‹ 1**

μλ¥Ό λ“¤μ–΄ JUnit ν”„λ μ„μ›ν¬ μ‚¬μ© μ‹ ν…μ¤νΈ λ©”μ†λ“ μ•μ— @Test μ• λ…Έν…μ΄μ…μ„ λ¶™μ—¬μ£Όμ–΄μ•Ό ν•λ‹¤.

```kotlin
import org.junit.*
class MyTest {
    @Test fun testTrue() { // @Test μ• λ…Έν…μ΄μ…μ΄ Junit ν”„λ μ„μ›ν¬μ—κ² μ΄ λ©”μ†λ“λ¥Ό ν…μ¤νΈλ΅ νΈμ¶ν•λΌκ³  μ§€μ‹ν•λ‹¤.
        Assert.assertTrue(true)
    }
}
```

**μμ‹ 2**

`@Deprecated` λ” μλ°”μ™€ μ½”ν‹€λ¦° μ—μ„ κ°™μ€ μλ―Έμ΄λ‹¤.

ν•μ§€λ§ μ½”ν‹€λ¦°μ—μ„λ” `replaceWith` νλΌλ―Έν„°λ¥Ό ν†µν•΄ μ› λ²„μ „μ„ λ€μ‹ ν•  μ μλ” ν¨ν„΄μ„ μ μ‹ν•  μ μλ‹¤.

API μ‚¬μ©μλ” κ·Έ ν¨ν„΄μ„ λ³΄κ³  μ§€μ›μ΄ μΆ…λ£λ  API κΈ°λ¥μ„ λ” μ‰½κ² μƒ λ²„μ „μΌλ΅ ν¬ν…ν•  μ μλ‹¤.

```kotlin
@Deprecated("Use removeAt(index) instead.", ReplaceWith("removeAt(index)"))
fun remove(index: Int) { /*...*/ }
```

μ• λ…Έν…μ΄μ…μ— μΈμλ¥Ό λ„κ²¨μ¤„ λ•λ” μΌλ° ν•¨μμ™€ λ§μ°¬κ°€μ§€λ΅ κ΄„νΈμ•μ— μΈμλ¥Ό λ„£μ–΄μ¤€λ‹¤.

μ΄λ° μ„ μ–Έμ΄ μλ‹¤λ©΄ IDEA μ—μ„ remove νΈμ¶ μ½”λ“μ— κ²½κ³ λ¥Ό λ„£μ–΄μ¤„ λΏλ§ μ•„λ‹λΌ μƒ API λ²„μ „μ— λ§λ” μ½”λ“λ΅ λ°”κΏ”μ£Όλ” quick fixλ„ μ μ‹ν•΄μ¤€λ‹¤.

## 10.2.3 μ• λ…Έν…μ΄μ…μ„ ν™μ©ν• μ§λ ¬ν™” μ μ–΄

μ μ΄ν‚¤λ“μ μ§λ ¬ν™” λΌμ΄λΈλ¬λ¦¬λ¥Ό μμ‹λ΅ μ§μ ‘ κµ¬ν„ν•΄λ³΄λ©΄μ„ μ• λ…Έν…μ΄μ…μ΄ μ–΄λ–»κ² μ“°μ΄λ”μ§€ μ•μ•„λ³Έλ‹¤.

- λ¦¬ν”λ ‰μ…μΌλ΅ μ‹¤ν–‰μ‹μ μ— μ½”ν‹€λ κ°μ²΄μ ν”„λ΅νΌν‹°λ¥Ό μ–»κ±°λ‚ JSON νμΌμ—μ„ μ½μ€ λ°μ΄ν„°λ¥Ό μ½”ν‹€λ¦° κ°μ²΄λ΅ λ§λ“ λ‹¤
- μ• λ…Έν…μ΄μ…μΌλ΅ μ μ΄ν‚¤λ“ λΌμ΄λΈλ¬λ¦¬κ°€ ν΄λμ¤μ™€ ν”„λ΅νΌν‹°λ¥Ό μ§λ ¬ν™”/μ—­μ§λ ¬ν™” ν•λ” λ°©μ‹μ„ μ΅°μ ν•λ‹¤

### @JsonExclude λ΅ μ• λ…Έν…μ΄μ…λ ν”„λ΅νΌν‹°

```kotlin
val properties = kClass.memberProperties
    .filter { it.findAnnotation<JsonExclude>() == null}
```

JsonExlude μ• λ…Έν…μ΄μ… λ ν”„λ΅νΌν‹°λ¥Ό ν•„ν„°λ§(μ μ™Έ) ν•λ‹¤. π‘

### @JsonName

```kotlin
annotation class JsonName(val name: String)

data class Person(
    @JsonName("alias") val firstName: String,
    val age: Int
)
```

@JsonName μ€ μ„μ™€ κ°™μ΄ μ‚¬μ©ν•  μ μμ—λ‹¤.

```kotlin
val jsonNameAnnotaion = prop.findAnnotation<JsonName>() // JsonName μ• λ…Έν…μ΄μ…μ„ μ–»λ”λ‹¤ (μ—†μΌλ©΄ null)
val proName = jsonNameAnnotation?.name ?: prop.name // JsonName μ name μΈμλ¥Ό μ°Ύκ³  μ—†μΌλ©΄ prop.name μ„ μ‚¬μ© 
```

μ°λ¦¬μ μ»¤μ¤ν…€ μ§λ ¬ν™” λ΅μ§μ— μ„ μ‚¬ν•­μ„ λ°μν•΄λ³΄μ

```kotlin
private fun StringBuilder.serializeObject(obj: Any) {
    obj.javaClass.kotlin.memberProperties
        .filter { it.findAnnotation<JsonExclude>() == null } // μ μ™Έ ν”„λ΅νΌν‹°λ¥Ό ν•„ν„°λ§ 
        .joinToStringBuilder(this, prefix = "{", postfix = "}") {
            serializeProperty(it, obj)
        }
}
```

β¬† @JsonExclude μ• λ…Έν…μ΄μ…μ„ μ²λ¦¬ν•λ‹¤.

```kotlin
private fun StringBuilder.serializeProperty(
    prop: KProperty1<Any, *>, obj: Any
) {
    val jsonNameAnn = prop.findAnnotation<JsonName>()
    val propName = jsonNameAnn?.name ?: prop.name // @JsonName μ— λ”°λΌ μ΄λ¦„ μ²λ¦¬
    serializeString(propName)
    append(": ")
    serializePropertyValue(prop.get(obj))
}
```

β¬† @JsonName μ„ μ²λ¦¬ν•λ‹¤.  

### `@CustomSerializer`

`@CustomSerializer` λ” `getSerializer` λΌλ” ν•¨μμ— κΈ°μ΄ν•λ‹¤.

`getSerializer` λ” `@CustomSerializer` λ¥Ό ν†µν•΄ λ“±λ΅ν• `ValueSerializer` μΈμ¤ν„΄μ¤λ¥Ό λ°ν™ν•λ‹¤.

```kotlin
data class Person(
    val name: String,
    @CustomSerializer(DateSerializer::class) val birthDate: Date
)
```

```kotlin
annotation class CustomSerializer(
    val serializerClass: KClass<out ValueSerializer<*>>
)
```

ν”„λ΅νΌν‹°μ κ°’μ„ μ§λ ¬ν™”ν•λ” μ§λ ¬ν™”κΈ° κ°€μ Έμ¤κΈ°

```kotlin
fun KProperty<*>.getSerializer(): ValueSerializer<Any?>? {
    val customSerializerAnn = findAnnotation<CustomSerializer>() ?: return null // @CustomSerializer κ°€ μλ”μ§€ μ°Ύμ
    val serializerClass = customSerializerAnn.serializerClass // μ§λ ¬ν™”κΈ° μΈμ¤ν„΄μ¤λ¥Ό μ–»κΈ° μ„ν• ν΄λμ¤
    val valueSerializer = serializerClass.objectInstance ?: serializerClass.createInstance() // objectInstance κ°€ μ—†μΌλ©΄ μΈμ¤ν„΄μ¤λ¥Ό μƒμ„±ν•΄μ•Ό ν•λ‹¤
    @Suppress("UNCHECKED_CAST")
    return valueSerializer as ValueSerializer<Any?>
}
```

`getSerializer()` κ°€ μ£Όλ΅ λ‹¤λ£¨λ” κ°μ²΄κ°€ `KProperty` μ μΈμ¤ν„΄μ¤ μ΄κΈ° λ•λ¬Έμ— `KProperty` μ ν™•μ¥ ν•¨μλ΅ μ •μ

ν΄λμ¤μ™€ κ°μ²΄λ” λ¨λ‘ `KClass` ν΄λμ¤λ΅ ν‘ν„λλ”λ°, κ°μ²΄μ—λ” object μ„ μ–Έμ— μν•΄ μƒμ„±λ μ‹±κΈ€ν„΄μ„ κ°€λ¦¬ν‚¤λ” `objectInstance` λΌλ” ν”„λ΅νΌν‹°κ°€ μλ‹¤. (ν΄λμ¤μ—λ” μ—†λ‹¤)

- μλ¥Ό λ“¤μ–΄ `DataSerializer`λ¥Ό `object` λ΅ μ„ μ–Έν• κ²½μ°μ—λ” `objectInstance` ν”„λ΅νΌν‹°μ— `DateSerializer` μ‹±κΈ€ν„΄ μΈμ¤ν„΄μ¤κ°€ λ“¤μ–΄μλ‹¤. (ν•΄λ‹Ή μΈμ¤ν„΄μ¤λ΅ λ¨λ“  κ°μ²΄λ¥Ό μ§λ ¬ν™” ν•λ©΄ λλ‹κΉ `createInstance` νΈμ¶μ΄ ν•„μ”μ—†λ‹¤)

ν•μ§€λ§ `KClass` κ°€ μΌλ° ν΄λμ¤λ¥Ό ν‘ν„ν•κ³  μλ‹¤λ©΄, `createInstance`λ¥Ό νΈμ¶ν•΄μ„ μƒ μΈμ¤ν„΄μ¤λ¥΄ λ§λ“¤μ–΄μ•Ό ν•λ‹¤.

serializeProperty κµ¬ν„ μ•μ—μ„ getSerializerλ¥Ό μ‚¬μ©ν•  μ μλ‹¤.

`serializeProperty` μµμΆ… λ²„μ „ μ½”λ“ (μ•„λ)

μ»¤μ¤ν…€ μ§λ ¬ν™”κΈ°λ¥Ό μ§€μ›ν•λ” ν”„λ΅νΌν‹° μ§λ ¬ν™” ν•¨μ

```kotlin
private fun StringBuilder.serializeProperty(
    prop: KProperty1<Any, *>, obj: Any
) {
    val name = prop.findAnnotation<JsonName>()?.name ?: prop.name
    serializeString(name)
    append(": ")

    val value = prop.get(obj)
    val jsonValue = prop.getSerializer()?.toJsonValue(value) ?: value // μ»¤μ¤ν…€ μ§λ ¬ν™”κΈ°κ°€ μμΌλ©΄ μ‚¬μ©ν•κ³  μ—†μΌλ©΄ μΌλ° μ μΈ λ°©λ²•μΌλ΅ ν”„λ΅νΌν‹°λ¥Ό μ§λ ¬ν™” ν•¨.
    serializePropertyValue(jsonValue)

}
```

`serializeProperty`λ” μ»¤μ¤ν…€ μ§λ ¬ν™”κΈ°κ°€ μλ”μ§€ ν™•μΈν•κ³  μμΌλ©΄ μ»¤μ¤ν…€ μ§λ ¬ν™”κΈ°λ¥Ό μ‚¬μ©ν•κ³  μ—†μΌλ©΄ ν”„λ΅νΌν‹° κ°’μ„ μ‚¬μ©ν•λ‹¤.

