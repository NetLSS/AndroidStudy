<!-- 
commit message
kotlin in action : Annotation

생략 된 챕터는 향후 채워질 예정. 🎅
-->

# 10장 에노테이션과 리플렉션

## 10.2.3 애노테이션을 활용한 직렬화 제어

제이키드의 직렬화 라이브러리를 예로 든다.

### @JsonExclude 로 애노테이션된 프로퍼티

```kotlin
val properties = kClass.memberProperties
    .filter { it.findAnnotation<JsonExclude>() == null}
```

JsonExlude 애노테이션 된 프로퍼티를 필터링(제외) 한다. 👍

### @JsonName

```kotlin
annotation class JsonName(val name: String)

data class Person(
    @JsonName("alias") val firstName: String,
    val age: Int
)
```

@JsonName 은 위와 같이 사용할 수 있었다.

```kotlin
val jsonNameAnnotaion = prop.findAnnotation<JsonName>() // JsonName 애노테이션을 얻는다 (없으면 null)
val proName = jsonNameAnnotation?.name ?: prop.name // JsonName 의 name 인자를 찾고 없으면 prop.name 을 사용 
```

우리의 커스텀 직렬화 로직에 위 사항을 반영해보자

```kotlin
private fun StringBuilder.serializeObject(obj: Any) {
    obj.javaClass.kotlin.memberProperties
        .filter { it.findAnnotation<JsonExclude>() == null } // 제외 프로퍼티를 필터링 
        .joinToStringBuilder(this, prefix = "{", postfix = "}") {
            serializeProperty(it, obj)
        }
}
```

⬆ @JsonExclude 애노테이션을 처리한다.

```kotlin
private fun StringBuilder.serializeProperty(
    prop: KProperty1<Any, *>, obj: Any
) {
    val jsonNameAnn = prop.findAnnotation<JsonName>()
    val propName = jsonNameAnn?.name ?: prop.name // @JsonName 에 따라 이름 처리
    serializeString(propName)
    append(": ")
    serializePropertyValue(prop.get(obj))
}
```

⬆ @JsonName 을 처리한다.  

### `@CustomSerializer`

`@CustomSerializer` 는 `getSerializer` 라는 함수에 기초한다.

`getSerializer` 는 `@CustomSerializer` 를 통해 등록한 `ValueSerializer` 인스턴스를 반환한다.

```kotlin
data class Person(
    val name: String,
    @CustomSerializer(DateSerializer::class) val birthDate: Date
)
```

```kotlin
annotation class CustomSerializer(
    val serializerClass: KClass<out ValueSerializer<*>>
)
```

프로퍼티의 값을 직렬화하는 직렬화기 가져오기

```kotlin
fun KProperty<*>.getSerializer(): ValueSerializer<Any?>? {
    val customSerializerAnn = findAnnotation<CustomSerializer>() ?: return null
    val serializerClass = customSerializerAnn.serializerClass
    val valueSerializer = serializerClass.objectInstance ?: serializerClass.createInstance()
    @Suppress("UNCHECKED_CAST")
    return valueSerializer as ValueSerializer<Any?>
}
```

`getSerializer()` 가 주로 다루는 객체가 `KProperty` 의 인스턴스 이기 때문에 `KProperty` 의 확장 함수로 정의


    